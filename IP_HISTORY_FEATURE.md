# 🌍 IP地址历史记录功能

## 功能概述

NOX AI 现在支持基于IP地址的历史记录管理，每个IP地址的聊天记录会被独立保存和管理。

## 🚀 核心特性

### 1. **自动IP识别**
- 自动获取用户的真实IP地址
- 支持代理和负载均衡环境
- 本地开发环境自动使用 `localhost`

### 2. **独立历史记录**
- 每个IP地址拥有独立的聊天历史
- 同一IP再次访问时自动加载历史记录
- 支持多用户同时使用，互不干扰

### 3. **实时同步**
- 消息自动保存到服务器
- 延迟保存机制，避免频繁IO操作
- 清空功能同步清理服务器端数据

## 📁 存储结构

```
data/
└── history/
    ├── localhost.json          # 本地开发记录
    ├── 192_168_1_100.json     # IP: 192.168.1.100
    ├── 10_0_0_5.json          # IP: 10.0.0.5
    └── ...
```

每个文件包含：
```json
{
  "ip": "192.168.1.100",
  "messages": [...],
  "lastUpdated": "2024-01-01T12:00:00.000Z",
  "messageCount": 25
}
```

## 🔌 API接口

### 1. 获取IP地址
```
GET /api/get-ip
```

### 2. 管理历史记录
```
GET  /api/history?ip=xxx.xxx.xxx.xxx    # 获取指定IP的历史
POST /api/history                       # 保存历史记录
DELETE /api/history?ip=xxx.xxx.xxx.xxx  # 清空指定IP的历史
```

### 3. 管理员概览
```
GET /api/admin/history                  # 获取所有IP的历史概览
```

## 🎯 用户体验

### 前端界面
- History按钮显示当前IP地址
- 自动加载历史记录（如果存在）
- 清空功能同时清理本地和服务器数据

### 隐私保护
- 数据存储在本地服务器
- 不上传到第三方服务
- 支持完全清空功能

## 🛠️ 技术实现

### IP获取策略
1. `x-forwarded-for` 头部（代理环境）
2. `x-real-ip` 头部（Nginx代理）
3. `cf-connecting-ip` 头部（Cloudflare）
4. `request.ip` 属性
5. 默认值处理

### 文件命名规则
- IP地址中的特殊字符替换为下划线
- 示例：`192.168.1.100` → `192_168_1_100.json`

### 错误处理
- API请求失败时的优雅降级
- 文件读写错误的异常处理
- 网络超时的重试机制

## 🔍 使用场景

1. **家庭环境**：不同设备的聊天记录独立管理
2. **办公环境**：每个工位的使用记录分别保存
3. **教育场景**：学生个人的学习记录跟踪
4. **开发测试**：不同环境的测试数据隔离

## 📊 管理功能

管理员可以通过 `/api/admin/history` 查看：
- 所有活跃IP地址
- 每个IP的消息数量
- 最后活跃时间
- 使用统计信息

## 🚀 后续优化

1. **数据压缩**：历史记录文件自动压缩
2. **定期清理**：自动清理过期记录
3. **导出功能**：支持历史记录导出
4. **用户认证**：结合用户登录系统
5. **云端同步**：可选的云端备份功能 