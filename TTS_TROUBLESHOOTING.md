# 🎵 CosyVoice TTS 故障排除指南

## 🔍 问题诊断

如果您的语音合成功能仍在使用浏览器原生TTS而不是CosyVoice，请按以下步骤进行诊断：

### 1. 快速检查
```bash
# 运行自动诊断脚本
npm run check-tts
```

### 2. 手动检查步骤

#### 步骤1：检查环境变量配置
```bash
# 确认 .env.local 文件存在
ls -la .env.local

# 检查内容（不要暴露真实密钥）
grep DASHSCOPE_API_KEY .env.local
```

**预期结果：**
- ✅ 文件存在
- ✅ 包含有效的 `DASHSCOPE_API_KEY=sk-xxxxxx`
- ❌ 如果显示 `your-dashscope-api-key-here`，需要替换为真实密钥

#### 步骤2：检查样音文件
```bash
# 查看样音文件目录
ls -la public/voice-samples/
```

**预期结果：**
- ✅ 目录存在
- ✅ 包含 `longxiaochun-utt3-0.wav` 或其他音频文件
- ⚠️ 如果为空，将使用预设音色

#### 步骤3：启动开发服务器
```bash
npm run dev
```

#### 步骤4：访问调试页面
打开浏览器访问：`http://localhost:3000/tts-debug.html`

## 🛠️ 常见问题解决方案

### 问题1：API密钥错误
**症状：** 控制台显示 "API密钥未配置" 或 401/403 错误

**解决方案：**
1. 访问 [阿里百炼控制台](https://dashscope.aliyun.com/)
2. 登录并获取有效的API密钥
3. 创建/编辑 `.env.local` 文件：
```bash
DASHSCOPE_API_KEY=sk-your-real-api-key-here
```
4. 重启开发服务器

### 问题2：服务未开通
**症状：** API返回服务不可用错误

**解决方案：**
1. 在阿里百炼控制台开通CosyVoice语音合成服务
2. 确认账户有足够的调用额度
3. 等待服务激活（通常几分钟）

### 问题3：样音文件问题
**症状：** 语音克隆效果不佳或失败

**解决方案：**
1. 检查样音文件格式（支持MP3、WAV、FLAC、M4A）
2. 确保文件大小不超过10MB
3. 音频时长建议3-30秒
4. 确保音频清晰无噪音

### 问题4：网络连接问题
**症状：** 请求超时或连接失败

**解决方案：**
1. 检查网络连接
2. 确认防火墙未阻止API请求
3. 尝试使用代理或VPN

### 问题5：异步任务超时
**症状：** 语音合成任务一直处理中

**解决方案：**
1. 等待更长时间（复杂任务可能需要1-2分钟）
2. 检查任务ID是否有效
3. 重新提交任务

## 🔧 调试工具使用

### TTS调试页面功能
访问 `http://localhost:3000/tts-debug.html`

1. **🔍 检查API状态** - 验证API端点可访问性
2. **📁 测试本地样音** - 使用本地样音文件进行语音合成
3. **🎵 测试语音合成** - 完整的TTS功能测试
4. **🗑️ 清除日志** - 清理调试信息

### 控制台日志
开启浏览器开发者工具，查看详细的API调用日志：
- 📤 请求参数
- 📥 响应状态
- 🔑 API密钥状态
- 📁 样音文件信息
- ⚡ 错误详情

## 📊 API状态码说明

| 状态码 | 含义 | 解决方案 |
|--------|------|----------|
| 200 | 成功 | 正常工作 |
| 400 | 请求参数错误 | 检查文本内容和参数格式 |
| 401 | 认证失败 | 检查API密钥 |
| 403 | 权限不足 | 确认服务已开通 |
| 429 | 请求过于频繁 | 等待后重试 |
| 500 | 服务器错误 | 稍后重试或联系技术支持 |

## 🚀 性能优化建议

1. **缓存策略**
   - 相同文本的音频会被缓存1小时
   - 避免重复请求相同内容

2. **样音文件优化**
   - 使用高质量的样音文件
   - 保持合适的文件大小
   - 选择清晰的语音片段

3. **请求优化**
   - 避免过长的文本（建议小于1000字符）
   - 合理设置采样率（22050Hz通常足够）

## 📞 获取帮助

如果问题仍未解决：

1. **查看日志**：检查控制台和服务器日志
2. **测试工具**：使用 `npm run check-tts` 自动诊断
3. **调试页面**：访问 `/tts-debug.html` 进行详细测试
4. **官方文档**：参考[阿里百炼CosyVoice文档](https://help.aliyun.com/zh/dashscope/developer-reference/cosyvoice-quick-start)

## ✅ 成功标志

当一切配置正确时，您应该看到：
- 控制台显示 "✅ 使用本地样音文件" 或 "🎤 使用预设音色"
- 调试页面显示 "✅ 语音合成成功"
- 主应用中点击语音按钮能听到高质量的合成语音
- 不再回退到浏览器原生TTS 