<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音识别修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 语音识别修复验证</h1>
        
        <div id="status" class="status info">
            准备就绪 - 点击开始测试语音识别功能
        </div>

        <div>
            <button id="testBtn" onclick="testVoiceRecognition()">开始语音识别测试</button>
            <button id="stopBtn" onclick="stopTest()" disabled>停止测试</button>
            <button onclick="clearLog()">清除日志</button>
        </div>

        <h3>📋 测试日志</h3>
        <div id="log" class="log">等待测试开始...</div>

        <h3>📊 测试结果</h3>
        <div id="results">
            <p><strong>音频格式支持:</strong> <span id="mimeType">检测中...</span></p>
            <p><strong>识别状态:</strong> <span id="recognitionStatus">未开始</span></p>
            <p><strong>错误计数:</strong> <span id="errorCount">0</span></p>
        </div>
    </div>

    <script>
        let isTesting = false;
        let errorCount = 0;
        let mediaRecorder = null;
        let stream = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function getSupportedMimeType() {
            const types = [
                'audio/wav',
                'audio/mp4',
                'audio/ogg;codecs=opus',
                'audio/webm',
                'audio/webm;codecs=opus'
            ];
            
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    log(`✅ 支持的音频格式: ${type}`);
                    document.getElementById('mimeType').textContent = type;
                    return type;
                }
            }
            
            log('⚠️ 使用默认格式: audio/wav');
            document.getElementById('mimeType').textContent = 'audio/wav (默认)';
            return 'audio/wav';
        }

        async function testVoiceRecognition() {
            if (isTesting) return;
            
            isTesting = true;
            errorCount = 0;
            document.getElementById('testBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('errorCount').textContent = '0';
            
            try {
                updateStatus('🎤 正在启动语音识别测试...', 'info');
                log('🚀 开始语音识别测试');
                
                // 检测音频格式支持
                const mimeType = getSupportedMimeType();
                
                // 获取麦克风权限
                log('🎙️ 请求麦克风权限...');
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 48000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                log('✅ 麦克风权限获取成功');
                updateStatus('🎙️ 麦克风已激活 - 请说话测试', 'success');
                document.getElementById('recognitionStatus').textContent = '录音中';
                
                // 设置录音器
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                let audioChunks = [];
                
                mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 0) {
                        log(`📦 收到音频数据: ${event.data.size} bytes`);
                        audioChunks.push(event.data);
                        
                        // 测试音频转换 - 收集更多块确保音频质量
                        if (audioChunks.length >= 2) {
                            const totalSize = audioChunks.reduce((sum, chunk) => sum + chunk.size, 0);
                            if (totalSize >= 4096) { // 至少4KB
                                const audioBlob = new Blob(audioChunks, { type: mimeType });
                                audioChunks = [];
                                
                                try {
                                    await testAudioConversion(audioBlob);
                                } catch (error) {
                                    errorCount++;
                                    document.getElementById('errorCount').textContent = errorCount.toString();
                                    log(`❌ 音频处理错误: ${error.message}`, 'error');
                                }
                            }
                        }
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    errorCount++;
                    document.getElementById('errorCount').textContent = errorCount.toString();
                    log(`❌ 录音器错误: ${event.error}`, 'error');
                };
                
                // 开始录音
                mediaRecorder.start(3000); // 每3秒一个块
                log('🎵 录音已开始，每3秒处理一次音频数据');
                
            } catch (error) {
                errorCount++;
                document.getElementById('errorCount').textContent = errorCount.toString();
                log(`❌ 测试启动失败: ${error.message}`, 'error');
                updateStatus('❌ 测试失败: ' + error.message, 'error');
                stopTest();
            }
        }

        async function testAudioConversion(audioBlob) {
            log(`🔧 测试音频转换，输入大小: ${audioBlob.size} bytes`);
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            try {
                const arrayBuffer = await audioBlob.arrayBuffer();
                log(`📊 读取音频数据: ${arrayBuffer.byteLength} bytes`);
                
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer.slice(0));
                log(`✅ 音频解码成功: 采样率=${audioBuffer.sampleRate}, 声道=${audioBuffer.numberOfChannels}, 时长=${audioBuffer.duration.toFixed(3)}s`);
                
                // 模拟重采样
                const targetSampleRate = 16000;
                const length = Math.floor(audioBuffer.length * targetSampleRate / audioBuffer.sampleRate);
                const offlineContext = new OfflineAudioContext(1, length, targetSampleRate);
                
                const source = offlineContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(offlineContext.destination);
                source.start();
                
                const resampledBuffer = await offlineContext.startRendering();
                log(`🔄 重采样完成: 新长度=${resampledBuffer.length}`);
                
                // 转换为PCM
                const samples = resampledBuffer.getChannelData(0);
                const int16Array = new Int16Array(samples.length);
                for (let i = 0; i < samples.length; i++) {
                    const s = Math.max(-1, Math.min(1, samples[i]));
                    int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                
                log(`✅ PCM转换完成: ${int16Array.buffer.byteLength} bytes`);
                updateStatus('✅ 音频处理正常 - 修复生效!', 'success');
                
            } finally {
                audioContext.close();
            }
        }

        function stopTest() {
            isTesting = false;
            document.getElementById('testBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recognitionStatus').textContent = '已停止';
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            log('🛑 测试已停止');
            updateStatus('测试已停止', 'info');
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            log('📋 日志已清除');
        }

        // 页面加载时检测支持
        window.onload = function() {
            getSupportedMimeType();
            log('🔧 页面加载完成，准备开始测试');
        };
    </script>
</body>
</html> 